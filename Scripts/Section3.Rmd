---
title: "Genetic background and genotype x environment interactions shape TPC evolution in Saccharomyces"
author: "Jennifer Molinet"
date: "2025-02-14"
output: html_document
---

To test if evolution in increasing temperature changes the shape of the TPC and to compare our results with existing evolutionary hypotheses, we phenotyped three individual genotypes from each evolved line at ten different temperatures to obtain evolved TPCs. These genotypes were the fastest growing colonies at the final evolutionary temperature from condition I (increasing temperature condition) and 25 °C for condition C (constant temperature condition). 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Libraries**

```{r}
suppressMessages(library(tidyverse))
library(ggplot2)
suppressMessages(library(reshape2))
library(rTPC)
library(nls.multstart)
library(broom)
library(minpack.lm)
library(ggpubr)
suppressMessages(library(car))
```

**Directories**

```{r}
output_dir <- "../results/Section3/"
input_dir <- "../data/Section3"
```

**Loading data**
```{r}
file_path <- file.path(input_dir, "Kinetic_parameters_ind.txt")
d <- read.table(file_path, header = TRUE, stringsAsFactors = FALSE)
head(d)
```
```{r}
d$Temperature <- as.numeric(d$Temperature)

colnames(d) <- c("Strain","Condition","Individual","Replicate","Highlight.1","ave_rate","OD","temp","Specie","Strain2", "Line")

d_ave <- d %>% 
  group_by(Strain,Specie,Strain2,Condition,temp) %>%
  dplyr::summarise(., sd = sd(ave_rate),
                   ave_rate = mean(ave_rate)) %>%
  ungroup()
head(d_ave)
```

**Generating thermal performance curves (TPCs)**

We fitted TPCs of each strain by plotting the maximum growth rate against temperature.
TPCs were fitted using the cardinal temperature model with inflection (CTMI).

```{r}
CTMI <- function(T, T_min, T_opt, T_max, R_opt) {
  R <- ifelse(T <= T_min | T >= T_max, 0,
              R_opt * ((T - T_max) * (T - T_min)^2) / ((T_opt - T_min) * ((T_opt - T_min) * (T - T_opt) - (T_opt - T_max) * (T_opt + T_min - 2 * T))))
  return(R)
}
```

Se-6 strain

```{r}
# Ancestral
SE_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SE2") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SE_A) +
  geom_point(aes(temp, ave_rate), SE_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SE_A$temp %>% unlist()
R_observed <- SE_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SE_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SE_A

# Extract parameter estimates
params_SE_A <- coef(fit_SE_A)

# Validate the model fit
summary(fit_SE_A)
calc_params(fit_SE_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.0005217
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SE_A <- CTMI(T_new, params_SE_A["T_min"], params_SE_A["T_opt"], params_SE_A["T_max"], params_SE_A["R_opt"])

# Visualize the results
R_predicted_SE_A <- data.frame(T=T_new, Rate = R_predicted_SE_A) 

ggplot(R_predicted_SE_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SE_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SE_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Se-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SE_C <- d %>% filter(Condition == "Control", Strain2 == "SE2") 

ggplot() +
  geom_point(aes(temp, ave_rate), SE_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SE_C$temp %>% unlist()
R_observed <- SE_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SE_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SE_C

# Extract parameter estimates
params_SE_C <- coef(fit_SE_C)

# Validate the model fit
summary(fit_SE_C)
calc_params(fit_SE_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.03462
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SE_C <- CTMI(T_new, params_SE_C["T_min"], params_SE_C["T_opt"], params_SE_C["T_max"], params_SE_C["R_opt"])

# Visualize the results
R_predicted_SE_C <- data.frame(T=T_new, Rate = R_predicted_SE_C) 

ggplot(R_predicted_SE_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SE_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Se-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SE_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SE_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SE_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SE_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SE_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SE_C <- R_predicted_SE_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SE_C)

ggplot(R_predicted_SE_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for SC') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SE_T <- d %>% filter(Condition == "Treatment", Strain2 == "SE2") 

ggplot() +
  geom_point(aes(temp, ave_rate), SE_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SE_T$temp %>% unlist()
R_observed <- SE_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SE_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SE_T

# Extract parameter estimates
params_SE_T <- coef(fit_SE_T)

# Validate the model fit
summary(fit_SE_T)
calc_params(fit_SE_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.1803
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SE_T <- CTMI(T_new, params_SE_T["T_min"], params_SE_T["T_opt"], params_SE_T["T_max"], params_SE_T["R_opt"])

# Visualize the results
R_predicted_SE_T <- data.frame(T=T_new, Rate = R_predicted_SE_T) 

ggplot(R_predicted_SE_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SE_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Se-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SE_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SE_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SE_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SE_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SE_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SE_T <- R_predicted_SE_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SE_T)

ggplot(R_predicted_SE_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for SE') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```

```{r}
all_SE2 <- ggplot(R_predicted_SE_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SE_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SE_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SE_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SE_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h)')+
  annotate("text",x=0,y=0.4,label="Se-6",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.4))
all_SE2
```
Su-4 strain

```{r}
# Ancestral
SU_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SU2") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SU_A) +
  geom_point(aes(temp, ave_rate), SU_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SU_A$temp %>% unlist()
R_observed <- SU_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SU_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SU_A

# Extract parameter estimates
params_SU_A <- coef(fit_SU_A)

# Validate the model fit
summary(fit_SU_A)
calc_params(fit_SU_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.001955
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SU_A <- CTMI(T_new, params_SU_A["T_min"], params_SU_A["T_opt"], params_SU_A["T_max"], params_SU_A["R_opt"])

# Visualize the results
R_predicted_SU_A <- data.frame(T=T_new, Rate = R_predicted_SU_A) 

ggplot(R_predicted_SU_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SU_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SU_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Su-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SU_C <- d %>% filter(Condition == "Control", Strain2 == "SU2") 

ggplot() +
  geom_point(aes(temp, ave_rate), SU_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SU_C$temp %>% unlist()
R_observed <- SU_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SU_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SU_C

# Extract parameter estimates
params_SU_C <- coef(fit_SU_C)

# Validate the model fit
summary(fit_SU_C)
calc_params(fit_SU_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.09842
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SU_C <- CTMI(T_new, params_SU_C["T_min"], params_SU_C["T_opt"], params_SU_C["T_max"], params_SU_C["R_opt"])

# Visualize the results
R_predicted_SU_C <- data.frame(T=T_new, Rate = R_predicted_SU_C) 

ggplot(R_predicted_SU_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SU_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Su-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SU_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SU_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SU_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SU_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SU_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SU_C <- R_predicted_SU_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SU_C)

ggplot(R_predicted_SU_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Su-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SU_T <- d %>% filter(Condition == "Treatment", Strain2 == "SU2") 

ggplot() +
  geom_point(aes(temp, ave_rate), SU_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SU_T$temp %>% unlist()
R_observed <- SU_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SU_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SU_T

# Extract parameter estimates
params_SU_T <- coef(fit_SU_T)

# Validate the model fit
summary(fit_SU_T)
calc_params(fit_SU_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.0762
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SU_T <- CTMI(T_new, params_SU_T["T_min"], params_SU_T["T_opt"], params_SU_T["T_max"], params_SU_T["R_opt"])

# Visualize the results
R_predicted_SU_T <- data.frame(T=T_new, Rate = R_predicted_SU_T) 

ggplot(R_predicted_SU_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SE_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Su-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SU_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SU_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SU_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SU_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SU_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SU_T <- R_predicted_SU_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SU_T)

ggplot(R_predicted_SU_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Su-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```

```{r}
all_SU2 <- ggplot(R_predicted_SU_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SU_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SU_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SU_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SU_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h)')+
  annotate("text",x=0,y=0.5,label="Su-4",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.5))
all_SU2
```

Sp-8 strain

```{r}
# Ancestral
SP_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SP2", temp != "16") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SP_A) +
  geom_point(aes(temp, ave_rate), SP_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SP_A$temp %>% unlist()
R_observed <- SP_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SP_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SP_A

# Extract parameter estimates
params_SP_A <- coef(fit_SP_A)

# Validate the model fit
summary(fit_SP_A)
calc_params(fit_SP_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.001039
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SP_A <- CTMI(T_new, params_SP_A["T_min"], params_SP_A["T_opt"], params_SP_A["T_max"], params_SP_A["R_opt"])

# Visualize the results
R_predicted_SP_A <- data.frame(T=T_new, Rate = R_predicted_SP_A) 

ggplot(R_predicted_SP_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SP_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SP_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sp-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SP_C <- d %>% filter(Condition == "Control", Strain2 == "SP2") 

ggplot() +
  geom_point(aes(temp, ave_rate), SP_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SP_C$temp %>% unlist()
R_observed <- SP_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SP_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SP_C

# Extract parameter estimates
params_SP_C <- coef(fit_SP_C)

# Validate the model fit
summary(fit_SP_C)
calc_params(fit_SP_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.307
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SP_C <- CTMI(T_new, params_SP_C["T_min"], params_SP_C["T_opt"], params_SP_C["T_max"], params_SP_C["R_opt"])

# Visualize the results
R_predicted_SP_C <- data.frame(T=T_new, Rate = R_predicted_SP_C) 

ggplot(R_predicted_SP_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SP_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sp-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SP_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SP_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SP_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SP_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SP_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SP_C <- R_predicted_SP_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SP_C)

ggplot(R_predicted_SP_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sp-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SP_T <- d %>% filter(Condition == "Treatment", Strain2 == "SP2") 

ggplot() +
  geom_point(aes(temp, ave_rate), SP_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SP_T$temp %>% unlist()
R_observed <- SP_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SP_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SP_T

# Extract parameter estimates
params_SP_T <- coef(fit_SP_T)

# Validate the model fit
summary(fit_SP_T)
calc_params(fit_SP_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.245
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SP_T <- CTMI(T_new, params_SP_T["T_min"], params_SP_T["T_opt"], params_SP_T["T_max"], params_SP_T["R_opt"])

# Visualize the results
R_predicted_SP_T <- data.frame(T=T_new, Rate = R_predicted_SP_T) 

ggplot(R_predicted_SP_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SP_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sp-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SP_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SP_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SP_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SP_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SP_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SP_T <- R_predicted_SP_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SP_T)

ggplot(R_predicted_SP_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sp-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```


```{r}
all_SP2 <- ggplot(R_predicted_SP_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SP_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SP_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SP_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SP_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h)')+
  annotate("text",x=0,y=0.6,label="Sp-8",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.6))
all_SP2
```

Sc-8 strain

```{r}
# Ancestral
SC_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SC1", temp != "20") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SC_A) +
  geom_point(aes(temp, ave_rate), SC_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SC_A$temp %>% unlist()
R_observed <- SC_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SC_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SC_A

# Extract parameter estimates
params_SC_A <- coef(fit_SC_A)

# Validate the model fit
summary(fit_SC_A)
calc_params(fit_SC_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.01057
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SC_A <- CTMI(T_new, params_SC_A["T_min"], params_SC_A["T_opt"], params_SC_A["T_max"], params_SC_A["R_opt"])

# Visualize the results
R_predicted_SC_A <- data.frame(T=T_new, Rate = R_predicted_SC_A) 

ggplot(R_predicted_SC_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SC_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SC_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sc-8') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SC_C <- d %>% filter(Condition == "Control", Strain2 == "SC1", temp != "20") 

ggplot() +
  geom_point(aes(temp, ave_rate), SC_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SC_C$temp %>% unlist()
R_observed <- SC_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SC_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SC_C

# Extract parameter estimates
params_SC_C <- coef(fit_SC_C)

# Validate the model fit
summary(fit_SC_C)
calc_params(fit_SC_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.4808
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SC_C <- CTMI(T_new, params_SC_C["T_min"], params_SC_C["T_opt"], params_SC_C["T_max"], params_SC_C["R_opt"])

# Visualize the results
R_predicted_SC_C <- data.frame(T=T_new, Rate = R_predicted_SC_C) 

ggplot(R_predicted_SC_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SC_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sc-8') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SC_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SC_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SC_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SC_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SC_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SC_C <- R_predicted_SC_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SC_C)

ggplot(R_predicted_SC_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sc-8') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SC_T <- d %>% filter(Condition == "Treatment", Strain2 == "SC1") 

ggplot() +
  geom_point(aes(temp, ave_rate), SC_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SC_T$temp %>% unlist()
R_observed <- SC_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SC_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SC_T

# Extract parameter estimates
params_SC_T <- coef(fit_SC_T)

# Validate the model fit
summary(fit_SC_T)
calc_params(fit_SC_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.4392
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SC_T <- CTMI(T_new, params_SC_T["T_min"], params_SC_T["T_opt"], params_SC_T["T_max"], params_SC_T["R_opt"])

# Visualize the results
R_predicted_SC_T <- data.frame(T=T_new, Rate = R_predicted_SC_T) 

ggplot(R_predicted_SC_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SC_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sc-8') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SC_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SC_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SC_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SC_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SC_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SC_T <- R_predicted_SC_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SC_T)

ggplot(R_predicted_SC_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sc-8') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```

```{r}
all_SC1 <- ggplot(R_predicted_SC_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SC_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SC_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SC_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SC_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h)')+
  annotate("text",x=0,y=0.7,label="Sc-8",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.7))
all_SC1
```


Sa-4 strain

```{r}
# Ancestral
SA_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SA2") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SA_A) +
  geom_point(aes(temp, ave_rate), SA_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SA_A$temp %>% unlist()
R_observed <- SA_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SA_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SA_A

# Extract parameter estimates
params_SA_A <- coef(fit_SA_A)

# Validate the model fit
summary(fit_SA_A)
calc_params(fit_SA_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.0000725
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SA_A <- CTMI(T_new, params_SA_A["T_min"], params_SA_A["T_opt"], params_SA_A["T_max"], params_SA_A["R_opt"])

# Visualize the results
R_predicted_SA_A <- data.frame(T=T_new, Rate = R_predicted_SA_A) 

ggplot(R_predicted_SA_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SA_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SA_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sa-4') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SA_C <- d %>% filter(Condition == "Control", Strain2 == "SA2") 

ggplot() +
  geom_point(aes(temp, ave_rate), SA_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SA_C$temp %>% unlist()
R_observed <- SA_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SA_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SA_C

# Extract parameter estimates
params_SA_C <- coef(fit_SA_C)

# Validate the model fit
summary(fit_SA_C)
calc_params(fit_SA_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.2658
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SA_C <- CTMI(T_new, params_SA_C["T_min"], params_SA_C["T_opt"], params_SA_C["T_max"], params_SA_C["R_opt"])

# Visualize the results
R_predicted_SA_C <- data.frame(T=T_new, Rate = R_predicted_SA_C) 

ggplot(R_predicted_SA_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SA_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sa-4') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SA_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SA_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SA_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SA_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SA_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SA_C <- R_predicted_SA_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SA_C)

ggplot(R_predicted_SA_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sa-4') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SA_T <- d %>% filter(Condition == "Treatment", Strain2 == "SA2") 

ggplot() +
  geom_point(aes(temp, ave_rate), SA_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SA_T$temp %>% unlist()
R_observed <- SA_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SA_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SA_T

# Extract parameter estimates
params_SA_T <- coef(fit_SA_T)

# Validate the model fit
summary(fit_SA_T)
calc_params(fit_SA_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.1585
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SA_T <- CTMI(T_new, params_SA_T["T_min"], params_SA_T["T_opt"], params_SA_T["T_max"], params_SA_T["R_opt"])

# Visualize the results
R_predicted_SA_T <- data.frame(T=T_new, Rate = R_predicted_SA_T) 

ggplot(R_predicted_SA_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SA_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sa-4') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SA_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SA_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SA_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SA_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SA_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SA_T <- R_predicted_SA_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SA_T)

ggplot(R_predicted_SA_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sa-4') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```

```{r}
all_SA2 <- ggplot(R_predicted_SA_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SA_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SA_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SA_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SA_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h)')+
  annotate("text",x=0,y=0.4,label="Sa-4",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.4))
all_SA2
```

Sm-6 strain

```{r}
# Ancestral
SM_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SM2") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SM_A) +
  geom_point(aes(temp, ave_rate), SM_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SM_A$temp %>% unlist()
R_observed <- SM_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SM_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SM_A

# Extract parameter estimates
params_SM_A <- coef(fit_SM_A)

# Validate the model fit
summary(fit_SM_A)
calc_params(fit_SM_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.003699
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SM_A <- CTMI(T_new, params_SM_A["T_min"], params_SM_A["T_opt"], params_SM_A["T_max"], params_SM_A["R_opt"])

# Visualize the results
R_predicted_SM_A <- data.frame(T=T_new, Rate = R_predicted_SM_A) 

ggplot(R_predicted_SM_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SM_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SM_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sm-6') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SM_C <- d %>% filter(Condition == "Control", Strain2 == "SM2") 

ggplot() +
  geom_point(aes(temp, ave_rate), SM_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SM_C$temp %>% unlist()
R_observed <- SM_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SM_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SM_C

# Extract parameter estimates
params_SM_C <- coef(fit_SM_C)

# Validate the model fit
summary(fit_SM_C)
calc_params(fit_SM_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.2402
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SM_C <- CTMI(T_new, params_SM_C["T_min"], params_SM_C["T_opt"], params_SM_C["T_max"], params_SM_C["R_opt"])

# Visualize the results
R_predicted_SM_C <- data.frame(T=T_new, Rate = R_predicted_SM_C) 

ggplot(R_predicted_SM_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SM_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sm-6') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SM_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SM_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SM_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SM_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SM_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SM_C <- R_predicted_SM_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SM_C)

ggplot(R_predicted_SM_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sm-6') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SM_T <- d %>% filter(Condition == "Treatment", Strain2 == "SM2", temp != "16") 

ggplot() +
  geom_point(aes(temp, ave_rate), SM_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SM_T$temp %>% unlist()
R_observed <- SM_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SM_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SM_T

# Extract parameter estimates
params_SM_T <- coef(fit_SM_T)

# Validate the model fit
summary(fit_SM_T)
calc_params(fit_SM_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.2175
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SM_T <- CTMI(T_new, params_SM_T["T_min"], params_SM_T["T_opt"], params_SM_T["T_max"], params_SM_T["R_opt"])

# Visualize the results
R_predicted_SM_T <- data.frame(T=T_new, Rate = R_predicted_SM_T) 

ggplot(R_predicted_SM_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SM_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sm-6') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SM_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SM_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SM_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SM_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SM_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SM_T <- R_predicted_SM_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SM_T)

ggplot(R_predicted_SM_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sm-6') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```

```{r}
all_SM2 <- ggplot(R_predicted_SM_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SM_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SM_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SM_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SM_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h)')+
  annotate("text",x=0,y=0.6,label="Sm-6",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.6))
all_SM2
```

Sc-2 strain

```{r}
# Ancestral
SC_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SC", temp!= "20") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SC_A) +
  geom_point(aes(temp, ave_rate), SC_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SC_A$temp %>% unlist()
R_observed <- SC_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SC_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SC_A

# Extract parameter estimates
params_SC_A <- coef(fit_SC_A)

# Validate the model fit
summary(fit_SC_A)
calc_params(fit_SC_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.0009743
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SC_A <- CTMI(T_new, params_SC_A["T_min"], params_SC_A["T_opt"], params_SC_A["T_max"], params_SC_A["R_opt"])

# Visualize the results
R_predicted_SC_A <- data.frame(T=T_new, Rate = R_predicted_SC_A) 

ggplot(R_predicted_SC_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SC_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SC_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sc-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SC_C <- d %>% filter(Condition == "Control", Strain2 == "SC") 

ggplot() +
  geom_point(aes(temp, ave_rate), SC_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SC_C$temp %>% unlist()
R_observed <- SC_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SC_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SC_C

# Extract parameter estimates
params_SC_C <- coef(fit_SC_C)

# Validate the model fit
summary(fit_SC_C)
calc_params(fit_SC_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.4629
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SC_C <- CTMI(T_new, params_SC_C["T_min"], params_SC_C["T_opt"], params_SC_C["T_max"], params_SC_C["R_opt"])

# Visualize the results
R_predicted_SC_C <- data.frame(T=T_new, Rate = R_predicted_SC_C) 

ggplot(R_predicted_SC_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SC_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sc-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SC_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SC_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SC_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SC_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SC_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SC_C <- R_predicted_SC_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SC_C)

ggplot(R_predicted_SC_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sc-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SC_T <- d %>% filter(Condition == "Treatment", Strain2 == "SC") 

ggplot() +
  geom_point(aes(temp, ave_rate), SC_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SC_T$temp %>% unlist()
R_observed <- SC_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SC_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SC_T

# Extract parameter estimates
params_SC_T <- coef(fit_SC_T)

# Validate the model fit
summary(fit_SC_T)
calc_params(fit_SC_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 1.072
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SC_T <- CTMI(T_new, params_SC_T["T_min"], params_SC_T["T_opt"], params_SC_T["T_max"], params_SC_T["R_opt"])

# Visualize the results
R_predicted_SC_T <- data.frame(T=T_new, Rate = R_predicted_SC_T) 

ggplot(R_predicted_SC_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SC_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sc-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SC_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SC_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SC_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SC_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SC_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SC_T <- R_predicted_SC_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SC_T)

ggplot(R_predicted_SC_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sc-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```

```{r}
all_SC <- ggplot(R_predicted_SC_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SC_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SC_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SC_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SC_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h)')+
  annotate("text",x=0,y=0.7,label="Sc-2",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.7))
all_SC
```

Se-1 strain

```{r}
# Ancestral
SE_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SE1") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SE_A) +
  geom_point(aes(temp, ave_rate), SE_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SE_A$temp %>% unlist()
R_observed <- SE_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SE_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SE_A

# Extract parameter estimates
params_SE_A <- coef(fit_SE_A)

# Validate the model fit
summary(fit_SE_A)
calc_params(fit_SE_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.002016
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SE_A <- CTMI(T_new, params_SE_A["T_min"], params_SE_A["T_opt"], params_SE_A["T_max"], params_SE_A["R_opt"])

# Visualize the results
R_predicted_SE_A <- data.frame(T=T_new, Rate = R_predicted_SE_A) 

ggplot(R_predicted_SE_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SE_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SE_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Se-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SE_C <- d %>% filter(Condition == "Control", Strain2 == "SE1") 

ggplot() +
  geom_point(aes(temp, ave_rate), SE_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SE_C$temp %>% unlist()
R_observed <- SE_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SE_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SE_C

# Extract parameter estimates
params_SE_C <- coef(fit_SE_C)

# Validate the model fit
summary(fit_SE_C)
calc_params(fit_SE_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.1263
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SE_C <- CTMI(T_new, params_SE_C["T_min"], params_SE_C["T_opt"], params_SE_C["T_max"], params_SE_C["R_opt"])

# Visualize the results
R_predicted_SE_C <- data.frame(T=T_new, Rate = R_predicted_SE_C) 

ggplot(R_predicted_SE_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SE_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Se-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SE_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SE_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SE_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SE_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SE_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SE_C <- R_predicted_SE_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SE_C)

ggplot(R_predicted_SE_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Se-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SE_T <- d %>% filter(Condition == "Treatment", Strain2 == "SE1") 

ggplot() +
  geom_point(aes(temp, ave_rate), SE_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SE_T$temp %>% unlist()
R_observed <- SE_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SE_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SE_T

# Extract parameter estimates
params_SE_T <- coef(fit_SE_T)

# Validate the model fit
summary(fit_SE_T)
calc_params(fit_SE_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.1671
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SE_T <- CTMI(T_new, params_SE_T["T_min"], params_SE_T["T_opt"], params_SE_T["T_max"], params_SE_T["R_opt"])

# Visualize the results
R_predicted_SE_T <- data.frame(T=T_new, Rate = R_predicted_SE_T) 

ggplot(R_predicted_SE_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SE_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Se-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SE_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SE_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SE_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SE_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SE_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SE_T <- R_predicted_SE_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SE_T)

ggplot(R_predicted_SE_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Se-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```

```{r}
all_SE1 <- ggplot(R_predicted_SE_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SE_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SE_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SE_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SE_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h)')+
  annotate("text",x=0,y=0.5,label="Se-1",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.5))
all_SE1
```
Sm-1 strain

```{r}
# Ancestral
SM_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SM1") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SM_A) +
  geom_point(aes(temp, ave_rate), SM_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SM_A$temp %>% unlist()
R_observed <- SM_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SM_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SM_A

# Extract parameter estimates
params_SM_A <- coef(fit_SM_A)

# Validate the model fit
summary(fit_SM_A)
calc_params(fit_SM_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.002329
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SM_A <- CTMI(T_new, params_SM_A["T_min"], params_SM_A["T_opt"], params_SM_A["T_max"], params_SM_A["R_opt"])

# Visualize the results
R_predicted_SM_A <- data.frame(T=T_new, Rate = R_predicted_SM_A) 

ggplot(R_predicted_SM_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SM_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SM_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sm-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SM_C <- d %>% filter(Condition == "Control", Strain2 == "SM1") 

ggplot() +
  geom_point(aes(temp, ave_rate), SM_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SM_C$temp %>% unlist()
R_observed <- SM_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SM_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SM_C

# Extract parameter estimates
params_SM_C <- coef(fit_SM_C)

# Validate the model fit
summary(fit_SM_C)
calc_params(fit_SM_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.1493
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SM_C <- CTMI(T_new, params_SM_C["T_min"], params_SM_C["T_opt"], params_SM_C["T_max"], params_SM_C["R_opt"])

# Visualize the results
R_predicted_SM_C <- data.frame(T=T_new, Rate = R_predicted_SM_C) 

ggplot(R_predicted_SM_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SM_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sm-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SM_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SM_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SM_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SM_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SM_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SM_C <- R_predicted_SM_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SM_C)

ggplot(R_predicted_SM_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sm-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SM_T <- d %>% filter(Condition == "Treatment", Strain2 == "SM1", temp != "20") 

ggplot() +
  geom_point(aes(temp, ave_rate), SM_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SM_T$temp %>% unlist()
R_observed <- SM_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SM_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SM_T

# Extract parameter estimates
params_SM_T <- coef(fit_SM_T)

# Validate the model fit
summary(fit_SM_T)
calc_params(fit_SM_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.1885
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SM_T <- CTMI(T_new, params_SM_T["T_min"], params_SM_T["T_opt"], params_SM_T["T_max"], params_SM_T["R_opt"])

# Visualize the results
R_predicted_SM_T <- data.frame(T=T_new, Rate = R_predicted_SM_T) 

ggplot(R_predicted_SM_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SM_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sm-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SM_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SM_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SM_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SM_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SM_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SM_T <- R_predicted_SM_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SM_T)

ggplot(R_predicted_SM_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sm-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```

```{r}
all_SM1 <- ggplot(R_predicted_SM_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SM_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SM_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SM_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SM_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h)')+
  annotate("text",x=0,y=0.6,label="Sm-1",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.6))
all_SM1
```
Su-2 strain

```{r}
# Ancestral
SU_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SU1") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SU_A) +
  geom_point(aes(temp, ave_rate), SU_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SU_A$temp %>% unlist()
R_observed <- SU_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SU_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SU_A

# Extract parameter estimates
params_SU_A <- coef(fit_SU_A)

# Validate the model fit
summary(fit_SU_A)
calc_params(fit_SU_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.001659
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SU_A <- CTMI(T_new, params_SU_A["T_min"], params_SU_A["T_opt"], params_SU_A["T_max"], params_SU_A["R_opt"])

# Visualize the results
R_predicted_SU_A <- data.frame(T=T_new, Rate = R_predicted_SU_A) 

ggplot(R_predicted_SU_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SU_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SU_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Su-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SU_C <- d %>% filter(Condition == "Control", Strain2 == "SU1") 

ggplot() +
  geom_point(aes(temp, ave_rate), SU_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SU_C$temp %>% unlist()
R_observed <- SU_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SU_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SU_C

# Extract parameter estimates
params_SU_C <- coef(fit_SU_C)

# Validate the model fit
summary(fit_SU_C)
calc_params(fit_SU_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.2848
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SU_C <- CTMI(T_new, params_SU_C["T_min"], params_SU_C["T_opt"], params_SU_C["T_max"], params_SU_C["R_opt"])

# Visualize the results
R_predicted_SU_C <- data.frame(T=T_new, Rate = R_predicted_SU_C) 

ggplot(R_predicted_SU_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SU_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Su-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SU_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SU_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SU_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SU_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SU_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SU_C <- R_predicted_SU_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SU_C)

ggplot(R_predicted_SU_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Su-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SU_T <- d %>% filter(Condition == "Treatment", Strain2 == "SU1") 

ggplot() +
  geom_point(aes(temp, ave_rate), SU_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SU_T$temp %>% unlist()
R_observed <- SU_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SU_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SU_T

# Extract parameter estimates
params_SU_T <- coef(fit_SU_T)

# Validate the model fit
summary(fit_SU_T)
calc_params(fit_SU_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.1065
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SU_T <- CTMI(T_new, params_SU_T["T_min"], params_SU_T["T_opt"], params_SU_T["T_max"], params_SU_T["R_opt"])

# Visualize the results
R_predicted_SU_T <- data.frame(T=T_new, Rate = R_predicted_SU_T) 

ggplot(R_predicted_SU_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SU_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Su-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SU_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SU_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SU_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SU_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SU_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SU_T <- R_predicted_SU_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SU_T)

ggplot(R_predicted_SU_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Su-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```

```{r}
all_SU1 <- ggplot(R_predicted_SU_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SU_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SU_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SU_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SU_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h')+
  annotate("text",x=0,y=0.5,label="Su-2",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.5))
all_SU1
```

Sk-4 strain

```{r}
# Ancestral
SK_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SK2") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SK_A) +
  geom_point(aes(temp, ave_rate), SK_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SK_A$temp %>% unlist()
R_observed <- SK_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SK_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SK_A

# Extract parameter estimates
params_SK_A <- coef(fit_SK_A)

# Validate the model fit
summary(fit_SK_A)
calc_params(fit_SK_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.001783
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SK_A <- CTMI(T_new, params_SK_A["T_min"], params_SK_A["T_opt"], params_SK_A["T_max"], params_SK_A["R_opt"])

# Visualize the results
R_predicted_SK_A <- data.frame(T=T_new, Rate = R_predicted_SK_A) 

ggplot(R_predicted_SK_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SK_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SK_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sk-4') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SK_C <- d %>% filter(Condition == "Control", Strain2 == "SK2", Strain != "SK2-1") 

ggplot() +
  geom_point(aes(temp, ave_rate), SK_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SK_C$temp %>% unlist()
R_observed <- SK_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SK_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SK_C

# Extract parameter estimates
params_SK_C <- coef(fit_SK_C)

# Validate the model fit
summary(fit_SK_C)
calc_params(fit_SK_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.0868
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SK_C <- CTMI(T_new, params_SK_C["T_min"], params_SK_C["T_opt"], params_SK_C["T_max"], params_SK_C["R_opt"])

# ViSKalize the results
R_predicted_SK_C <- data.frame(T=T_new, Rate = R_predicted_SK_C) 

ggplot(R_predicted_SK_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SK_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sk-4') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SK_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SK_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SK_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SK_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SK_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SK_C <- R_predicted_SK_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SK_C)

ggplot(R_predicted_SK_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sk-4') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SK_T <- d %>% filter(Condition == "Treatment", Strain2 == "SK2", Strain != "SK2-2") 

ggplot() +
  geom_point(aes(temp, ave_rate), SK_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SK_T$temp %>% unlist()
R_observed <- SK_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SK_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SK_T

# Extract parameter estimates
params_SK_T <- coef(fit_SK_T)

# Validate the model fit
summary(fit_SK_T)
calc_params(fit_SK_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.114
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SK_T <- CTMI(T_new, params_SK_T["T_min"], params_SK_T["T_opt"], params_SK_T["T_max"], params_SK_T["R_opt"])

# Visualize the results
R_predicted_SK_T <- data.frame(T=T_new, Rate = R_predicted_SK_T) 

ggplot(R_predicted_SK_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SK_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sk-4') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SK_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SK_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SK_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SK_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SK_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SK_T <- R_predicted_SK_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SK_T)

ggplot(R_predicted_SK_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sk-4') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```

```{r}
all_SK2 <- ggplot(R_predicted_SK_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SK_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SK_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SK_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SK_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h)')+
  annotate("text",x=0,y=0.35,label="Sk-4",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.35))
all_SK2
```

Sk-1 strain

```{r}
# Ancestral
SK_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SK1") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SK_A) +
  geom_point(aes(temp, ave_rate), SK_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SK_A$temp %>% unlist()
R_observed <- SK_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SK_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SK_A

# Extract parameter estimates
params_SK_A <- coef(fit_SK_A)

# Validate the model fit
summary(fit_SK_A)
calc_params(fit_SK_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.008598
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SK_A <- CTMI(T_new, params_SK_A["T_min"], params_SK_A["T_opt"], params_SK_A["T_max"], params_SK_A["R_opt"])

# Visualize the results
R_predicted_SK_A <- data.frame(T=T_new, Rate = R_predicted_SK_A) 

ggplot(R_predicted_SK_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SK_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SK_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sk-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SK_C <- d %>% filter(Condition == "Control", Strain2 == "SK1", Highlight.1 != "SK1-4_Control_I3", Highlight.1 != "SK1-1_Control_I2", Highlight.1 != "SK1-2_Control_I2") 

ggplot() +
  geom_point(aes(temp, ave_rate), SK_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SK_C$temp %>% unlist()
R_observed <- SK_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SK_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SK_C

# Extract parameter estimates
params_SK_C <- coef(fit_SK_C)

# Validate the model fit
summary(fit_SK_C)
calc_params(fit_SK_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.2413
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SK_C <- CTMI(T_new, params_SK_C["T_min"], params_SK_C["T_opt"], params_SK_C["T_max"], params_SK_C["R_opt"])

# ViSKalize the results
R_predicted_SK_C <- data.frame(T=T_new, Rate = R_predicted_SK_C) 

ggplot(R_predicted_SK_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SK_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sk-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SK_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SK_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SK_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SK_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SK_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SK_C <- R_predicted_SK_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SK_C)

ggplot(R_predicted_SK_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sk-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SK_T <- d %>% filter(Condition == "Treatment", Strain2 == "SK1") 

ggplot() +
  geom_point(aes(temp, ave_rate), SK_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SK_T$temp %>% unlist()
R_observed <- SK_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SK_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SK_T

# Extract parameter estimates
params_SK_T <- coef(fit_SK_T)

# Validate the model fit
summary(fit_SK_T)
calc_params(fit_SK_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.2531
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SK_T <- CTMI(T_new, params_SK_T["T_min"], params_SK_T["T_opt"], params_SK_T["T_max"], params_SK_T["R_opt"])

# Visualize the results
R_predicted_SK_T <- data.frame(T=T_new, Rate = R_predicted_SK_T) 

ggplot(R_predicted_SK_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SK_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sk-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SK_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SK_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SK_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SK_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SK_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SK_T <- R_predicted_SK_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SK_T)

ggplot(R_predicted_SK_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sk-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```

```{r}
all_SK1 <- ggplot(R_predicted_SK_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SK_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SK_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SK_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SK_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h)')+
  annotate("text",x=0,y=0.4,label="Sk-1",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.4))
all_SK1
```

Sj-1 strain

```{r}
# Ancestral
SJ_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SJ1") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SJ_A) +
  geom_point(aes(temp, ave_rate), SJ_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SJ_A$temp %>% unlist()
R_observed <- SJ_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SJ_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SJ_A

# Extract parameter estimates
params_SJ_A <- coef(fit_SJ_A)

# Validate the model fit
summary(fit_SJ_A)
calc_params(fit_SJ_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.00346
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SJ_A <- CTMI(T_new, params_SJ_A["T_min"], params_SJ_A["T_opt"], params_SJ_A["T_max"], params_SJ_A["R_opt"])

# Visualize the results
R_predicted_SJ_A <- data.frame(T=T_new, Rate = R_predicted_SJ_A) 

ggplot(R_predicted_SJ_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SJ_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SJ_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sj-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SJ_C <- d %>% filter(Condition == "Control", Strain2 == "SJ1") 

ggplot() +
  geom_point(aes(temp, ave_rate), SJ_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SJ_C$temp %>% unlist()
R_observed <- SJ_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SJ_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SJ_C

# Extract parameter estimates
params_SJ_C <- coef(fit_SJ_C)

# Validate the model fit
summary(fit_SJ_C)
calc_params(fit_SJ_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.7547
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SJ_C <- CTMI(T_new, params_SJ_C["T_min"], params_SJ_C["T_opt"], params_SJ_C["T_max"], params_SJ_C["R_opt"])

# ViSJalize the results
R_predicted_SJ_C <- data.frame(T=T_new, Rate = R_predicted_SJ_C) 

ggplot(R_predicted_SJ_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SJ_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sj-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SJ_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SJ_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SJ_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SJ_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SJ_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SJ_C <- R_predicted_SJ_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SJ_C)

ggplot(R_predicted_SJ_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sj-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SJ_T <- d %>% filter(Condition == "Treatment", Strain2 == "SJ1") 

ggplot() +
  geom_point(aes(temp, ave_rate), SJ_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SJ_T$temp %>% unlist()
R_observed <- SJ_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SJ_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SJ_T

# Extract parameter estimates
params_SJ_T <- coef(fit_SJ_T)

# Validate the model fit
summary(fit_SJ_T)
calc_params(fit_SJ_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.3887
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SJ_T <- CTMI(T_new, params_SJ_T["T_min"], params_SJ_T["T_opt"], params_SJ_T["T_max"], params_SJ_T["R_opt"])

# Visualize the results
R_predicted_SJ_T <- data.frame(T=T_new, Rate = R_predicted_SJ_T) 

ggplot(R_predicted_SJ_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SJ_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sj-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SJ_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SJ_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SJ_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SJ_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SJ_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SJ_T <- R_predicted_SJ_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SJ_T)

ggplot(R_predicted_SJ_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sj-1') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```

```{r}
all_SJ1 <- ggplot(R_predicted_SJ_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SJ_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SJ_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SJ_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SJ_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h)')+
  annotate("text",x=0,y=0.6,label="Sj-1",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.6))
all_SJ1
```

Sj-2 strain

```{r}
# Ancestral
SJ_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SJ2") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SJ_A) +
  geom_point(aes(temp, ave_rate), SJ_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SJ_A$temp %>% unlist()
R_observed <- SJ_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SJ_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SJ_A

# Extract parameter estimates
params_SJ_A <- coef(fit_SJ_A)

# Validate the model fit
summary(fit_SJ_A)
calc_params(fit_SJ_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.004313
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SJ_A <- CTMI(T_new, params_SJ_A["T_min"], params_SJ_A["T_opt"], params_SJ_A["T_max"], params_SJ_A["R_opt"])

# Visualize the results
R_predicted_SJ_A <- data.frame(T=T_new, Rate = R_predicted_SJ_A) 

ggplot(R_predicted_SJ_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SJ_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SJ_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sj-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SJ_C <- d %>% filter(Condition == "Control", Strain2 == "SJ2", temp != "20") 

ggplot() +
  geom_point(aes(temp, ave_rate), SJ_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SJ_C$temp %>% unlist()
R_observed <- SJ_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SJ_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SJ_C

# Extract parameter estimates
params_SJ_C <- coef(fit_SJ_C)

# Validate the model fit
summary(fit_SJ_C)
calc_params(fit_SJ_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.5174
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SJ_C <- CTMI(T_new, params_SJ_C["T_min"], params_SJ_C["T_opt"], params_SJ_C["T_max"], params_SJ_C["R_opt"])

# ViSJalize the results
R_predicted_SJ_C <- data.frame(T=T_new, Rate = R_predicted_SJ_C) 

ggplot(R_predicted_SJ_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SJ_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sj-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SJ_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SJ_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SJ_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SJ_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SJ_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SJ_C <- R_predicted_SJ_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SJ_C)

ggplot(R_predicted_SJ_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sj-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SJ_T <- d %>% filter(Condition == "Treatment", Strain2 == "SJ2", temp != "20") 

ggplot() +
  geom_point(aes(temp, ave_rate), SJ_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SJ_T$temp %>% unlist()
R_observed <- SJ_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SJ_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SJ_T

# Extract parameter estimates
params_SJ_T <- coef(fit_SJ_T)

# Validate the model fit
summary(fit_SJ_T)
calc_params(fit_SJ_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.2513
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SJ_T <- CTMI(T_new, params_SJ_T["T_min"], params_SJ_T["T_opt"], params_SJ_T["T_max"], params_SJ_T["R_opt"])

# Visualize the results
R_predicted_SJ_T <- data.frame(T=T_new, Rate = R_predicted_SJ_T) 

ggplot(R_predicted_SJ_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SJ_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sj-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SJ_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SJ_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SJ_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SJ_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SJ_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SJ_T <- R_predicted_SJ_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SJ_T)

ggplot(R_predicted_SJ_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sj-2') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```

```{r}
all_SJ2 <- ggplot(R_predicted_SJ_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SJ_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SJ_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SJ_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SJ_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h)')+
  annotate("text",x=0,y=0.5,label="Sj-2",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.5))
all_SJ2
``` 

Sp-5 strain

```{r}
# Ancestral
SP_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SP1", temp != "20") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SP_A) +
  geom_point(aes(temp, ave_rate), SP_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SP_A$temp %>% unlist()
R_observed <- SP_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SP_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SP_A

# Extract parameter estimates
params_SP_A <- coef(fit_SP_A)

# Validate the model fit
summary(fit_SP_A)
calc_params(fit_SP_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.00009578
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SP_A <- CTMI(T_new, params_SP_A["T_min"], params_SP_A["T_opt"], params_SP_A["T_max"], params_SP_A["R_opt"])

# Visualize the results
R_predicted_SP_A <- data.frame(T=T_new, Rate = R_predicted_SP_A) 

ggplot(R_predicted_SP_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SP_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SP_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sp-5') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SP_C <- d %>% filter(Condition == "Control", Strain2 == "SP1") 

ggplot() +
  geom_point(aes(temp, ave_rate), SP_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SP_C$temp %>% unlist()
R_observed <- SP_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SP_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SP_C

# Extract parameter estimates
params_SP_C <- coef(fit_SP_C)

# Validate the model fit
summary(fit_SP_C)
calc_params(fit_SP_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.1978
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SP_C <- CTMI(T_new, params_SP_C["T_min"], params_SP_C["T_opt"], params_SP_C["T_max"], params_SP_C["R_opt"])

# Visualize the results
R_predicted_SP_C <- data.frame(T=T_new, Rate = R_predicted_SP_C) 

ggplot(R_predicted_SP_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SP_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sp-5') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SP_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SP_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SP_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SP_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SP_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SP_C <- R_predicted_SP_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SP_C)

ggplot(R_predicted_SP_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sp-5') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SP_T <- d %>% filter(Condition == "Treatment", Strain2 == "SP1", ave_rate != "NA") 

ggplot() +
  geom_point(aes(temp, ave_rate), SP_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SP_T$temp %>% unlist()
R_observed <- SP_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SP_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SP_T

# Extract parameter estimates
params_SP_T <- coef(fit_SP_T)

# Validate the model fit
summary(fit_SP_T)
calc_params(fit_SP_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.1814
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SP_T <- CTMI(T_new, params_SP_T["T_min"], params_SP_T["T_opt"], params_SP_T["T_max"], params_SP_T["R_opt"])

# Visualize the results
R_predicted_SP_T <- data.frame(T=T_new, Rate = R_predicted_SP_T) 

ggplot(R_predicted_SP_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SP_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sp-5') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SP_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SP_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SP_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SP_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SP_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SP_T <- R_predicted_SP_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SP_T)

ggplot(R_predicted_SP_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sp-5') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```

```{r}
all_SP1 <- ggplot(R_predicted_SP_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SP_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SP_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SP_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SP_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h)')+
  annotate("text",x=0,y=0.6,label="Sp-5",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.6))
all_SP1
```

Sc-13 strain

```{r}
# Ancestral
SC_A <- d_ave %>% filter(Condition == "Ancestral", Strain2 == "SC2") 

ggplot() +
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SC_A) +
  geom_point(aes(temp, ave_rate), SC_A, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SC_A$temp %>% unlist()
R_observed <- SC_A$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SC_A <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SC_A

# Extract parameter estimates
params_SC_A <- coef(fit_SC_A)

# Validate the model fit
summary(fit_SC_A)
calc_params(fit_SC_A)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.01333
R2 <- 1 - (SSR / SST)
R2


# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SC_A <- CTMI(T_new, params_SC_A["T_min"], params_SC_A["T_opt"], params_SC_A["T_max"], params_SC_A["R_opt"])

# Visualize the results
R_predicted_SC_A <- data.frame(T=T_new, Rate = R_predicted_SC_A) 

ggplot(R_predicted_SC_A) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SC_A, size = 2, shape = 21, fill ="black")+
  geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), SC_A) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sc-13') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))


# Condition control
SC_C <- d %>% filter(Condition == "Control", Strain2 == "SC2") 

ggplot() +
  geom_point(aes(temp, ave_rate), SC_C, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SC_C$temp %>% unlist()
R_observed <- SC_C$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SC_C <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SC_C

# Extract parameter estimates
params_SC_C <- coef(fit_SC_C)

# Validate the model fit
summary(fit_SC_C)
calc_params(fit_SC_C)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.5416
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SC_C <- CTMI(T_new, params_SC_C["T_min"], params_SC_C["T_opt"], params_SC_C["T_max"], params_SC_C["R_opt"])

# Visualize the results
R_predicted_SC_C <- data.frame(T=T_new, Rate = R_predicted_SC_C) 

ggplot(R_predicted_SC_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SC_C, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sc-13') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SC_C), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SC_C))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SC_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SC_C$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SC_C$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SC_C <- R_predicted_SC_C %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SC_C)

ggplot(R_predicted_SC_C) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sc-13') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))

# Condition treatment
SC_T <- d %>% filter(Condition == "Treatment", Strain2 == "SC2") 

ggplot() +
  geom_point(aes(temp, ave_rate), SC_T, size = 2, shape = 21, fill = 'green4') +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x ='Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rates across temperatures') +
  geom_hline(aes(yintercept = 0), linetype = 2)


T <- SC_T$temp %>% unlist()
R_observed <- SC_T$ave_rate %>% unlist()

# Fit the CTMI model to the data with adjusted starting values
fit_SC_T <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                  start = list(T_min = 0, T_opt = 20, T_max = 37, R_opt = 0.25))  # Adjusted starting value for 'c'
fit_SC_T

# Extract parameter estimates
params_SC_T <- coef(fit_SC_T)

# Validate the model fit
summary(fit_SC_T)
calc_params(fit_SC_T)

SST <- sum((R_observed - mean(R_observed))^2)
SSR <- 0.4922
R2 <- 1 - (SSR / SST)
R2

# Make predictions
T_new <- seq(0, 42, by = 0.5)
R_predicted_SC_T <- CTMI(T_new, params_SC_T["T_min"], params_SC_T["T_opt"], params_SC_T["T_max"], params_SC_T["R_opt"])

# Visualize the results
R_predicted_SC_T <- data.frame(T=T_new, Rate = R_predicted_SC_T) 

ggplot(R_predicted_SC_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_point(aes(temp, ave_rate), SC_T, size = 2, shape = 21, fill ="black")+
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sc-13') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,44))+
  ylim(c(0,0.8))

# Realizar boostrapping para obtener la distribución de los parámetros del modelo
n_bootstraps <- 1000  # Número de iteraciones de boostrapping
bootstrapped_parameters <- matrix(nrow = n_bootstraps, ncol = 4)  # Matriz para almacenar los parámetros de cada iteración

for (i in 1:n_bootstraps) {
  # Muestreo con reemplazo de los índices de los datos
  sampled_indices <- sample(1:length(R_observed), replace = TRUE)
  
  # Subconjunto de los datos observados
  subset_data <- data.frame(T = T[sampled_indices], R_observed = R_observed[sampled_indices])
  
  # Ajustar el modelo a los datos muestreados
  bootstrap_fit <- nlsLM(R_observed ~ CTMI(T, T_min, T_opt, T_max, R_opt),
                         start = coef(fit_SC_T), data = subset_data)
  
  # Guardar los parámetros ajustados
  bootstrapped_parameters[i, ] <- coef(bootstrap_fit)
}

# Visualizar la distribución de los parámetros
par(mfrow = c(2, 2))
for (j in 1:4) {
  hist(bootstrapped_parameters[, j], main = names(coef(fit_SC_T))[j], xlab = "")
}

for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Crear la ventana de gráficos
par(mfrow = c(1, 1))

# Graficar la curva del modelo original
plot(T_new, R_predicted_SC_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")
lines(T_new, R_predicted_SC_T$Rate, col = "blue")

# Graficar las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  R_pred_boot <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
  lines(T_new, R_pred_boot, col = "gray", lty = 2)
}

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping"), col = c("blue", "gray"), lty = c(1, 2))

# Crear una matriz para almacenar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
bootstrapped_predictions <- matrix(NA, nrow = length(T_new), ncol = n_bootstraps)

# Generar las curvas de rendimiento térmico predichas para cada iteración de boostrapping
for (i in 1:n_bootstraps) {
  bootstrapped_predictions[, i] <- CTMI(T_new, bootstrapped_parameters[i, 1], bootstrapped_parameters[i, 2], bootstrapped_parameters[i, 3], bootstrapped_parameters[i, 4])
}

# Graficar la curva del modelo original
plot(T_new, R_predicted_SC_T$Rate, type = "l", col = "blue", xlab = "Temperatura", ylab = "Rendimiento Térmico", main = "Curva de Rendimiento Térmico")

# Superponer las curvas obtenidas mediante boostrapping
for (i in 1:n_bootstraps) {
  lines(T_new, bootstrapped_predictions[, i], col = "gray", lty = 2)
}

# Calcular y graficar el intervalo de confianza
lower_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.025)
upper_bound <- apply(bootstrapped_predictions, 1, quantile, probs = 0.975)
lines(T_new, apply(bootstrapped_predictions, 1, median), col = "red", lwd = 2)  # Mediana de las curvas de rendimiento térmico predichas
lines(T_new, lower_bound, col = "green", lwd = 2, lty = 2)  # Límite inferior del intervalo de confianza
lines(T_new, upper_bound, col = "green", lwd = 2, lty = 2)  # Límite superior del intervalo de confianza

# Agregar leyenda
legend("topright", legend = c("Modelo Original", "Boostrapping", "Intervalo de Confianza"), col = c("blue", "gray", "red", "green"), lty = c(1, 2, 1, 2), lwd = c(1, 1, 2, 2))

R_predicted_SC_T <- R_predicted_SC_T %>%
  mutate(lwr = lower_bound, upr = upper_bound)
head(R_predicted_SC_T)

ggplot(R_predicted_SC_T) +
  geom_line(aes(x=T, y=Rate), color = "blue") +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        plot.title = element_text(size = 16,face = "bold"),
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12)) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures for Sc-13') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2) +
  xlim(c(0,42))+
  ylim(c(0,0.8))
```

```{r}
all_SC2 <- ggplot(R_predicted_SC_A) +
  geom_area(aes(x=T, y=Rate), fill = "black", alpha = 0.15) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#4575B4",R_predicted_SC_C) +
  geom_line(aes(x=T, y=Rate),linewidth=0.9,color="#D6604D",R_predicted_SC_T) +
  # CI
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#4575B4", alpha = 0.2,R_predicted_SC_C) +
  geom_ribbon(aes(x= T,ymin = lwr, ymax = upr), fill = "#D6604D", alpha = 0.2,R_predicted_SC_T) +
  #Resto
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_text( size = 14),
        axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14)) +
  labs(x = 'Temperature (ºC)',
       y = 'Max. growth rate (OD/h)',
       title = 'Sc-2')+
  annotate("text",x=0,y=0.8,label="Sc-13",fontface="bold",size=6, color="black",hjust = 0)+
  xlim(c(0,42))+
  ylim(c(0,0.8))
all_SC2
```

Plotting figure 4

```{r figure4, fig.width=12, fig.height=15}
Figure4 <- ggarrange(all_SE1,all_SE2,all_SU1,all_SU2,all_SA2,all_SK1,all_SK2,
                       all_SJ1,all_SJ2,all_SM1,all_SM2,all_SP1,all_SP2,all_SC1,all_SC2,all_SC,
                     ncol = 4, nrow = 4)
Figure4
ggsave(filename = file.path(output_dir, "Figure_4.tiff"), plot = Figure4, width = 12, height = 15, dpi = 300)
```

We found evidence for strong genotype-by-environment (G x E) interactions, where the effect of the evolution regime (C vs. I) varied between species , with significant differences between the TPCs of evolved genotypes under increasing temperature and the TPCs of ancestral strains. In contrast, TPCs of evolved genotypes under constant temperature were not significantly different from TPCs of ancestral strains.

Two-way ANOVA
```{r}
file_path <- file.path(input_dir, "Kinetic_parameters_ind.txt")
d <- read.table(file_path, header = TRUE, stringsAsFactors = FALSE)
d2 <- d %>% filter(Highlight.1 != "SK1-4_Control_I3",Highlight.1 != "SK1-1_Control_I2",Highlight.1 != "SK1-2_Control_I2",
                   Highlight.1 != "SK2-1_Control_I1",Highlight.1 != "SK2-2_Treatment_I1",Highlight.1 != "SP1-3_Treatment_I3") 

my_anova <- aov(Rate ~ Condition * Specie, data = d2)
Anova(my_anova, type = "III")

TukeyHSD(my_anova, which = "Specie")
TukeyHSD(my_anova, which = "Condition")
```


Linear mixed model

```{r}
reduced_model <- lmer(Rate ~ 1 + (1|Specie/Strain2), data = d2, REML = FALSE)
null_model1 <- lmer(Rate ~ Condition + (1|Specie/Strain2), data = d2, REML = FALSE)
null_model2 <- lmer(Rate ~ Temperature + (1|Specie/Strain2), data = d2, REML = FALSE)
full_model3 <- lmer(Rate ~ Temperature+Condition + (1|Specie/Strain2), data = d2, REML = FALSE)
full_model7 <- lmer(Rate ~ Temperature*Condition + (1|Specie/Strain2), data = d2, REML = FALSE)

anova(reduced_model, null_model1, null_model2, full_model3,full_model7)

summary(full_model7)
```
When analysing thermal performance parameters for each genotype, overall, we did not observe a significant increase in optimum growth temperature (Topt) between evolved genotypes and ancestral strains in either constant or increasing temperature conditions. 

Plotting figure S9

```{r}
file_path <- file.path(input_dir, "thermal_parameters_rel.txt")
d <- read.table(file_path, header = TRUE, stringsAsFactors = FALSE)
d$Species <- ordered(d$Species, levels = c("Se","Su","Sa","Sk","Sj","Sm","Sp","Sc"))
head(d)
```

```{r}
topt <- d %>% 
  filter(Condition != "Ancestral") %>%
  ggplot(aes(x=Condition, y=topt_rel, fill=Condition)) +
  geom_violin(trim=FALSE)+
  geom_boxplot(width=0.1, fill="white")+
  geom_hline(yintercept = 0, linetype = 2)+
  scale_fill_manual(values = c("#4575B4","#D6604D")) +
  ylab("Diff. in optimum temperature (°C)") +
  xlab("") +
  ggtitle("Optimum temperature")+
  theme_bw()+
  theme(axis.title.y = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14),
        plot.title = element_text(size = 16,face = "bold",hjust = 0.5),
        legend.position = 'none')
topt
```

```{r}
breadth <- d %>% 
  filter(Condition != "Ancestral") %>%
  ggplot(aes(x=Condition, y=breadth_rel, fill=Condition)) +
  geom_violin(trim=FALSE)+
  geom_boxplot(width=0.1, fill="white")+
  geom_hline(yintercept = 0, linetype = 2)+
  scale_fill_manual(values = c("#4575B4","#D6604D")) +
  ylab("Diff. in thermal breadth (°C)") +
  xlab("") +
  ggtitle("Thermal breadth")+
  theme_bw()+
  theme(axis.title.y = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14),
        plot.title = element_text(size = 16,face = "bold",hjust = 0.5),
        legend.position = 'none')
breadth
```
```{r figureS9, fig.width=12, fig.height=6}
figureS9 <- ggarrange(topt,breadth,
                      ncol = 2, nrow = 1)
figureS9

ggsave(filename = file.path(output_dir, "Figure_S9.tiff"), plot = figureS9, width = 12, height = 6, dpi = 300)
```
But genotypes evolved under increasing temperatures (I) showed a significant 1.3 °C increase in the critical thermal maximum and, at the same time, a 10% decrease in the maximum growth performance. This indicates that evolving towards a higher maximum growth temperature negatively affects the overall maximum performance (Pmax). We also found that evolution in both constant and increasing temperatures generated a 5.5 °C increase in the critical thermal minimum and a 5 °C decrease in thermal tolerance, suggesting a possible trade-off between maximizing growth at a specific temperature and maintaining the ability to grow across a broader range of temperatures.

```{r}
rmax <- d %>% 
  filter(Condition != "Ancestral") %>%
  ggplot(aes(x=Condition, y=rmax_rel, fill=Condition)) +
  geom_violin(trim=FALSE)+
  geom_boxplot(width=0.1, fill="white")+
  geom_hline(yintercept = 0, linetype = 2)+
  scale_fill_manual(values = c("#4575B4","#D6604D")) +
  ylab("Diff. in Pmax (OD/h)") +
  xlab("") +
  ggtitle("Pmax")+
  theme_bw()+
  theme(axis.title.y = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14),
        plot.title = element_text(size = 16,face = "bold",hjust = 0.5),
        legend.position = 'none')
rmax
```

```{r}
ctmax <- d %>% 
  filter(Condition != "Ancestral") %>%
  ggplot(aes(x=Condition, y=ctmax_rel, fill=Condition)) +
  geom_violin(trim=FALSE)+
  geom_boxplot(width=0.1, fill="white")+
  geom_hline(yintercept = 0, linetype = 2)+
  scale_fill_manual(values = c("#4575B4","#D6604D")) +
  ylab("Diff. in CTmax (°C)") +
  xlab("") +
  ggtitle("CTmax")+
  theme_bw()+
  theme(axis.title.y = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14),
        plot.title = element_text(size = 16,face = "bold",hjust = 0.5),
        legend.position = 'none')
ctmax
```
```{r}
ctmin <- d %>% 
  filter(Condition != "Ancestral") %>%
  ggplot(aes(x=Condition, y=ctmin_rel, fill=Condition)) +
  geom_violin(trim=FALSE)+
  geom_boxplot(width=0.1, fill="white")+
  geom_hline(yintercept = 0, linetype = 2)+
  scale_fill_manual(values = c("#4575B4","#D6604D")) +
  ylab("Diff. in CTmin (°C)") +
  xlab("") +
  ggtitle("CTmin")+
  theme_bw()+
  theme(axis.title.y = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14),
        plot.title = element_text(size = 16,face = "bold",hjust = 0.5),
        legend.position = 'none')
ctmin
```
```{r}
tolerance <- d %>% 
  filter(Condition != "Ancestral") %>%
  ggplot(aes(x=Condition, y=tolerance_rel, fill=Condition)) +
  geom_violin(trim=FALSE)+
  geom_boxplot(width=0.1, fill="white")+
  geom_hline(yintercept = 0, linetype = 2)+
  scale_fill_manual(values = c("#4575B4","#D6604D")) +
  ylab("Diff. in thermal tolerance (°C)") +
  xlab("") +
  ggtitle("Thermal tolerance")+
  theme_bw()+
  theme(axis.title.y = element_text( size = 14),
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14),
        plot.title = element_text(size = 16,face = "bold",hjust = 0.5),
        legend.position = 'none')
tolerance
```

Plotting figure 5A
```{r figure5A, fig.width=18, fig.height=6}
figure5a <- ggarrange(rmax,ctmax,ctmin,tolerance,
                                ncol = 4, nrow = 1)
figure5a

ggsave(filename = file.path(output_dir, "Figure_5A.tiff"), plot = figure5a, width = 12, height = 6, dpi = 300)
```

Genotypes evolved under increasing temperature did not show a correlation between optimum growth temperature (Topt) and maximum performance (Pmax). However, their Topt did increase significantly with thermal tolerance. Thus, some genotypes evolved to tolerate a wider range of temperatures without a considerable shift in their Topt and Pmax after experimental evolution. This pattern is consistent with the “hotter is wider” hypothesis. Other genotypes showed significant negative correlations between Topt and both critical thermal maximum (CTmax) and thermal breadth (Tbr). Similarly, these genotypes also showed significant negative correlations between Pmax and both CTmax and Tbr. This suggests that these genotypes evolved to grow at higher temperatures but at the cost of decreased performance overall – a pattern consistent with the “a jack of all temperatures is a master of none” or generalist strategy.

Plotting figure S10

```{r}
c5 <- d %>% filter(Condition != "Ancestral") %>% 
  ggplot(aes(x=topt_rel,y=rmax_rel,color=Condition))+
  geom_point(size=2)+
  geom_smooth(method = "lm", se=TRUE)+
  scale_color_manual(values = c("#4575B4","#D6604D")) +
  xlab("Diff. in Topt (°C)")+
  ylab("Diff. in Pmax (OD/h)")+
  theme_bw()+
  theme(axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text( size = 14),
        axis.text.y = element_text(size = 14),
        legend.text = element_text(size = 16), legend.title = element_text(size = 16)) 

c6 <- d %>% filter(Condition != "Ancestral") %>% 
  ggplot(aes(x=topt_rel,y=tolerance_rel,color=Condition))+
  geom_point(size=2)+
  geom_smooth(method = "lm", se=TRUE)+
  scale_color_manual(values = c("#4575B4","#D6604D")) +
  xlab("Diff. in Topt (°C)")+
  ylab("Diff. in Thermal tolerance (°C)")+
  theme_bw()+
  theme(axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text( size = 14),
        axis.text.y = element_text(size = 14),
        legend.text = element_text(size = 16), legend.title = element_text(size = 16)) 

c7 <- d %>% filter(Condition != "Ancestral") %>% 
  ggplot(aes(x=topt_rel,y=ctmax_rel,color=Condition))+
  geom_point(size=2)+
  geom_smooth(method = "lm", se=TRUE)+
  scale_color_manual(values = c("#4575B4","#D6604D")) +
  xlab("Diff. in Topt (°C)")+
  ylab("Diff. in CTmax (°C)")+
  theme_bw()+
  theme(axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text( size = 14),
        axis.text.y = element_text(size = 14),
        legend.text = element_text(size = 16), legend.title = element_text(size = 16)) 

c8 <- d %>% filter(Condition != "Ancestral") %>% 
  ggplot(aes(x=rmax_rel,y=ctmax_rel,color=Condition))+
  geom_point(size=2)+
  geom_smooth(method = "lm", se=TRUE)+
  scale_color_manual(values = c("#4575B4","#D6604D")) +
  xlab("Diff. in Pmax (OD/h)")+
  ylab("Diff. in CTmax (°C)")+
  theme_bw()+
  theme(axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text( size = 14),
        axis.text.y = element_text(size = 14),
        legend.text = element_text(size = 16), legend.title = element_text(size = 16)) 

c9 <- d %>% filter(Condition != "Ancestral") %>% 
  ggplot(aes(x=topt_rel,y=breadth_rel,color=Condition))+
  geom_point(size=2)+
  geom_smooth(method = "lm", se=TRUE)+
  scale_color_manual(values = c("#4575B4","#D6604D")) +
  xlab("Diff. in Topt (°C)")+
  ylab("Diff. in Tbr (°C)")+
  theme_bw()+
  theme(axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text( size = 14),
        axis.text.y = element_text(size = 14),
        legend.text = element_text(size = 16), legend.title = element_text(size = 16)) 


c10 <- d %>% filter(Condition != "Ancestral") %>% 
  ggplot(aes(x=rmax_rel,y=breadth_rel,color=Condition))+
  geom_point(size=2)+
  geom_smooth(method = "lm", se=TRUE)+
  scale_color_manual(values = c("#4575B4","#D6604D")) +
  xlab("Diff. in Pmax (OD/h)")+
  ylab("Diff. in Tbr (°C)")+
  theme_bw()+
  theme(axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text( size = 14),
        axis.text.y = element_text(size = 14),
        legend.text = element_text(size = 16), legend.title = element_text(size = 16)) 

c11 <- d %>% filter(Condition != "Ancestral") %>% 
  ggplot(aes(x=ctmax_rel,y=ctmin_rel,color=Condition))+
  geom_point(size=2)+
  geom_smooth(method = "lm", se=TRUE)+
  scale_color_manual(values = c("#4575B4","#D6604D")) +
  xlab("Diff. in CTmax (°C)")+
  ylab("Diff. in CTmin (°C)")+
  theme_bw()+
  theme(axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text( size = 14),
        axis.text.y = element_text(size = 14),
        legend.text = element_text(size = 16), legend.title = element_text(size = 16)) 

c5
c6
c7
c8
c9
c10
c11
```

```{r figureS10, fig.width=12, fig.height=8}

figureS10 <- ggarrange(c5,c6,c7,c8,c9, c10,c11,
                       ncol=4, nrow = 2, common.legend = TRUE, legend = "bottom") 
figureS10

ggsave(filename = file.path(output_dir, "Figure_S10.tiff"), plot = figureS10, width = 12, height = 8, dpi = 300)
```

Overall, there was considerable variation between genotypes, with all individual correlation coefficients below 0.7. This suggests diversity in adaptive strategies: some genotypes can evolve to tolerate a wide range of temperatures without a considerable shift in their Topt and Pmax. Thus, the evolution of TPCs varies across the genus Saccharomyces and does not only follow a single predicted pattern 

Since species significantly differed in the growth rates of C- and I-evolved populations, we also compared the evolution of TPCs across species. Under increasing temperature evolution, we observed a significant negative correlation between changes in Pmax with CTmax and Tbr in genotypes belonging to *S. eubayanus*, *S. uvarum*, *S. kudriavzevii*, and *S. mikatae* relative to their ancestors. This suggests “a-jack-of-all temperatures is a-master-of-none” pattern where selection for increased CTmax comes at a cost of fitness. The observed increase in Tbr in the genotypes belonging to these species is consistent with this generalist strategy.

In contrast, genotypes of the species *S. arboricola*, *S. jurei*, *S. paradoxus*, and *S. cerevisiae* showed the “hotter is wider” pattern with a significant positive correlation between changes in Topt and thermal tolerance respective to their ancestral strains. 

Plotting figure 5B

```{r}
file_path <- file.path(input_dir, "param_rel_final.txt")
d <- read.table(file_path, header = TRUE, stringsAsFactors = FALSE)
d$Species <- ordered(d$Species, levels = c("Se","Su","Sk","Sa","Sj","Sm","Sp","Sc"))
head(d)
```


```{r}
param_rel_filt <- d %>% filter(Condition == "Treatment", Species %in% c("Se","Su","Sk","Sm"))

c28 <- param_rel_filt %>% 
  ggplot(aes(x=rmax_rel,y=ctmax_rel))+
  geom_point(size=3, aes(color=Species))+
  geom_smooth(method = "lm", se=TRUE, color="black")+
  scale_color_manual(values = c("#08519C","#88419D","#2B8CBE","#980043"))+
  xlab("Diff. in Pmax (OD/h)")+
  ylab("Diff. in CTmax (°C)")+
  theme_bw()+
  theme(axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text( size = 14),
        axis.text.y = element_text(size = 14),
        legend.text = element_text(size = 16), legend.title = element_text(size = 16)) 
c28


c29 <- param_rel_filt %>% 
  ggplot(aes(x=rmax_rel,y=breadth_rel))+
  geom_point(size=3, aes(color=Species))+
  geom_smooth(method = "lm", se=TRUE, color="black")+
  scale_color_manual(values = c("#08519C","#88419D","#2B8CBE","#980043"))+
  xlab("Diff. in Pmax (OD/h)")+
  ylab("Diff. in Tbr (°C)")+
  theme_bw()+
  theme(axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text( size = 14),
        axis.text.y = element_text(size = 14),
        legend.text = element_text(size = 16), legend.title = element_text(size = 16)) 
c29
```

```{r}
param_rel_filt <- d %>% filter(Condition == "Treatment", Species %in% c("Sa","Sj","Sp","Sc"))

c32 <- param_rel_filt %>% 
  ggplot(aes(x=topt_rel,y=tolerance_rel))+
  geom_point(size=3, aes(color=Species))+
  geom_smooth(method = "lm", se=TRUE, color="black")+
  scale_color_manual(values = c("#238B45","#737373","#D94801","#CB181D"))+
  xlab("Diff. in Topt (°C)")+
  ylab("Diff. in Thermal tolerance (°C)")+
  theme_bw()+
  theme(axis.title.x = element_text( size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text( size = 14),
        axis.text.y = element_text(size = 14),
        legend.text = element_text(size = 16), legend.title = element_text(size = 16)) 
c32
```

```{r figure5b, fig.width=15, fig.height=6}
figure5b <- ggarrange(c28,c29,c32,
                       ncol=3, nrow = 1)
figure5b

ggsave(filename = file.path(output_dir, "Figure_5B.tiff"), plot = figure5b, width = 15, height = 6, dpi = 300)
``` 

Plotting final figure 5

```{r figureS4C, fig.width=18, fig.height=12}
figure5 <- ggarrange(figure5a,figure5b,
                     labels = c("A", "B"),
                     ncol = 1, nrow = 2)
figure5

ggsave(filename = file.path(output_dir, "Figure_5.tiff"), plot = figure5, width = 18, height = 12, dpi = 300)
```

These results suggest that the adaptive strategies to increasing temperatures are species-dependent and unrelated to the ancestral temperature tolerance. We expected genotypes belonging to species in the cold-tolerant group (*S. eubayanus*, *S. arboricola*, *S. kudriavzevii*), and to species in the warm-tolerant group (*S. cerevisiae*, *S. paradoxus*, *S. mikatae*) to exhibit similar evolutionary patterns under increasing temperature evolution. Against our expectations, the genotypes from the cold-tolerant species *S. eubayanus*, *S. arboricola*, and *S. kudriavzevii* do not follow the same pattern. In contrast, genotypes from *S. arboricola* follow the same evolutionary pattern as the genotypes from warm-tolerant species *S. cerevisiae* and *S. paradoxus*.
